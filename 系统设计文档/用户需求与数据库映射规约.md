# TjuFood 平台 - 用户需求与数据库映射规约

**版本: 1.0**

**文档目的**: 本文档旨在将《用户需求规格书》中定义的功能性需求，与项目的数据库物理模型进行精确的映射。它将详细说明每一个业务功能点背后所依赖的核心数据表和关键字段，作为开发人员进行具体功能实现时的数据访问指南。

## 1. 核心业务实体与基础数据表映射

| 业务实体      | 核心数据库表      | 关键字段说明                                                 |
| ------------- | ----------------- | ------------------------------------------------------------ |
| **用户**      | `tb_user`         | `id` (主键), `phone` (登录凭据), `password` (加密存储), `nick_name`, `avatar` (头像URL), `credit` (积分), `status` (账户状态), `is_deleted` (逻辑删除) |
| **管理员**    | `tb_admin`        | `id` (主键), `username` (登录凭据), `password` (加密存储), `role_id` (角色外键), `status` (账户状态), `is_deleted` |
| **校区**      | `tb_campus`       | `id` (主键), `name` (校区名称), `description` (描述)         |
| **食堂**      | `tb_canteen`      | `id` (主键), `name` (食堂名称), `campus_id` (校区外键), `type_id` (食堂分类外键), `location`, `business_hours` |
| **窗口**      | `tb_stall`        | `id` (主键), `name` (窗口名称), `canteen_id` (食堂外键), `type_id` (窗口分类外键), `avg_rating` (平均评分), `avg_price` (人均消费) |
| **菜品**      | `tb_dish`         | `id` (主键), `name` (菜品名称), `stall_id` (窗口外键), `price`, `rating` (评分) |
| **博客/笔记** | `tb_blog`         | `id` (主键), `user_id` (作者外键), `title`, `content`, `images` (图片URL列表), `liked_count` (点赞数), `status` (审核状态) |
| **评价**      | `tb_stall_review` | `id` (主键), `user_id` (作者外键), `stall_id` (评价对象外键), `rating` (评分), `content`, `images` (图片URL列表), `status` (审核状态) |
| **评论**      | `tb_comment`      | `id` (主键), `user_id` (作者外键), `parent_id` (父评论ID, 用于楼中楼), `entity_id` (被评论实体ID), `entity_type` (被评论实体类型: 博客/评价), `content` |

## 2. 功能需求与数据库操作详解

### 2.1 A级功能 (核心MVP)

#### **A-1: 账号认证体系**

- **需求**: 用户注册与登录
  - **注册**: 向 `tb_user` 表 `INSERT` 一条新记录。
    - `phone`, `password` 字段为必填。
    - `nick_name` 将生成一个默认值（如：“用户_xxxx”）。
    - `create_time`, `update_time` 将设置为当前时间。
  - **登录**: 根据传入的 `phone` 从 `tb_user` 表 `SELECT` 记录，比对 `password` 字段的哈希值。
- **需求**: 管理员登录
  - **登录**: 根据传入的 `username` 从 `tb_admin` 表 `SELECT` 记录，比对 `password` 字段。成功后，根据 `role_id` 查询 `tb_role_permission` 和 `tb_permission` 以确定其权限范围。

#### **A-2: 核心餐饮数据浏览**

- **需求**: 按层级浏览信息
  - **查校区**: `SELECT * FROM tb_campus WHERE is_deleted = 0;`
  - **查某校区下的食堂**: `SELECT * FROM tb_canteen WHERE campus_id = ? AND is_deleted = 0;`
  - **查某食堂下的窗口**: `SELECT * FROM tb_stall WHERE canteen_id = ? AND is_deleted = 0;`
  - **查某窗口下的菜品**: `SELECT * FROM tb_dish WHERE stall_id = ? AND is_deleted = 0;`

#### **A-3: 核心UGC - 窗口评价**

- **需求**: 对窗口进行图文评价和评分
  - 向 `tb_stall_review` 表 `INSERT` 一条新记录。
    - `user_id` 为当前登录用户ID。
    - `stall_id` 为被评价的窗口ID。
    - `rating` 和 `content` 由用户提供。
    - `status` 字段初始值设为“待审核”。
  - **[联动更新]**: 当该评价审核通过后，需重新计算并 `UPDATE` `tb_stall` 表中对应窗口的 `avg_rating` 字段。

#### **A-4: 后台基础管理**

- **需求**: 餐饮数据管理
  - 此功能将对 `tb_campus`, `tb_canteen`, `tb_canteen_type`, `tb_stall`, `tb_stall_type`, `tb_dish` 等表执行完整的 `INSERT`, `UPDATE` (包括逻辑删除 `is_deleted=1`), 和 `SELECT` 操作。
- **需求**: 内容审核
  - `SELECT * FROM tb_stall_review WHERE status = '待审核';`
  - 管理员操作后，`UPDATE tb_stall_review SET status = '已通过' / '已驳回' WHERE id = ?;`

### 2.2 B级功能 (完善体验)

#### **B-1: 社区功能扩展**

- **需求**: 博客系统
  - **发布**: 向 `tb_blog` 表 `INSERT` 一条记录，`status` 初始为“待审核”。
  - **点赞**: `UPDATE tb_blog SET liked_count = liked_count + 1 WHERE id = ?;` 同时，在Redis中记录点赞关系以防重复点赞。
- **需求**: 评论与互动
  - **发表评论**: 向 `tb_comment` 表 `INSERT` 记录，包含 `user_id`, `entity_id` (博客/评价的ID), `entity_type`, `content` 等关键信息。
  - **收藏**: 向 `tb_favorite` 表 `INSERT` 一条记录，包含 `user_id` 和被收藏实体的 `entity_id` 及 `entity_type`。

#### **B-2: 运营与激励体系**

- **需求**: 积分系统
  - **行为触发**: 当用户完成特定行为（如每日签到、发布第一篇评价），将触发积分变更。
  - `UPDATE tb_user SET credit = credit + ? WHERE id = ?;`
  - 同时，向 `tb_credit_record` 表 `INSERT` 一条流水记录，详细描述积分变动原因（`reason`）、变动数值（`amount`）和时间。
- **需求**: 运营工具
  - **公告管理**: 对 `tb_notice` 表进行CRUD操作。
  - **轮播图管理**: 对 `tb_banner` 表进行CRUD操作，`url` 字段存储图片链接，`link` 字段存储跳转地址。
- **需求**: 安全与合规
  - **敏感词管理**: 对 `tb_sensitive_word` 表进行CRUD操作，`word` 字段存储敏感词。
  - **举报处理**: 用户发起举报时，向 `tb_report` 表 `INSERT` 记录，包含 `user_id`, `entity_id`, `entity_type`, `reason` 等。管理员后台查询此表进行处理。

### 2.3 C级功能 (创新与未来)

#### **C-1: 智能服务 - AI问答**

- **需求**: AI本地知识库问答
  - 此功能主要不直接操作业务数据库的核心表，而是依赖于一个预先构建好的**知识库**。
  - **知识库构建**: 后端需有一个流程，定期或手动地从 `tb_dish`, `tb_stall_review`, `tb_blog` 等表中提取高质量的文本信息（如菜品描述、高赞评价、精华博客内容），处理后存入专门的向量数据库或带有向量索引功能的表中，供AI检索。
  - **聊天记录**: 用户与AI的对话历史，将 `INSERT` 到 `ai.chat_message` 表中，`conversation_id` 用于标识会话，`message` 存储对话内容。